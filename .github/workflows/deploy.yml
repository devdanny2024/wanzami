name: Deploy backend

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REPO: ${{ vars.ECR_REPO }}
  CLUSTER: ${{ vars.CLUSTER }}
  SERVICE_API: ${{ vars.SERVICE_API }}
  SERVICE_TRANSCODE: ${{ vars.SERVICE_TRANSCODE }}
  SERVICE_CRON: ${{ vars.SERVICE_CRON }}
  TASKDEF_API: ${{ vars.TASKDEF_API }}
  TASKDEF_TRANSCODE: ${{ vars.TASKDEF_TRANSCODE }}
  TASKDEF_CRON: ${{ vars.TASKDEF_CRON }}
  DATABASE_URL: ${{ secrets.DATABASE_URL || '' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (for Prisma)
        if: ${{ env.DATABASE_URL != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps (backend)
        if: ${{ env.DATABASE_URL != '' }}
        working-directory: ./backend
        run: npm ci

      - name: Run Prisma migrate + generate
        if: ${{ env.DATABASE_URL != '' }}
        working-directory: ./backend
        run: |
          npx prisma migrate deploy
          npx prisma generate

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          DOCKER_BUILDKIT: 1
        run: |
          IMAGE_TAG=${GITHUB_SHA}
          docker build -t $ECR_REPO:latest -t $ECR_REPO:$IMAGE_TAG ./backend
          docker push $ECR_REPO:latest
          docker push $ECR_REPO:$IMAGE_TAG

      - name: Update API task definition and service
        run: |
          IMAGE="$ECR_REPO:${GITHUB_SHA}"
          TASKDEF_API_USE=${TASKDEF_API:-wanzami-backend-task}
          TD=$(aws ecs describe-task-definition --task-definition $TASKDEF_API_USE)
          UPDATED=$(echo "$TD" | jq --arg IMG "$IMAGE" '
            .taskDefinition
            | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)
            | .containerDefinitions[0].image = $IMG
          ')
          echo "$UPDATED" > /tmp/td-api.json
          REV_ARN=$(aws ecs register-task-definition --cli-input-json file:///tmp/td-api.json --query 'taskDefinition.taskDefinitionArn' --output text)
          aws ecs update-service --cluster $CLUSTER --service $SERVICE_API --task-definition "$REV_ARN" --force-new-deployment

      - name: Update Transcode worker
        run: |
          IMAGE="$ECR_REPO:${GITHUB_SHA}"
          TASKDEF_TRANSCODE_USE=${TASKDEF_TRANSCODE:-wanzami-worker-transcode}
          TD=$(aws ecs describe-task-definition --task-definition $TASKDEF_TRANSCODE_USE)
          UPDATED=$(echo "$TD" | jq --arg IMG "$IMAGE" '
            .taskDefinition
            | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)
            | .containerDefinitions[0].image = $IMG
          ')
          echo "$UPDATED" > /tmp/td-transcode.json
          REV_ARN=$(aws ecs register-task-definition --cli-input-json file:///tmp/td-transcode.json --query 'taskDefinition.taskDefinitionArn' --output text)
          aws ecs update-service --cluster $CLUSTER --service $SERVICE_TRANSCODE --task-definition "$REV_ARN" --force-new-deployment

      - name: Update Cron worker
        run: |
          IMAGE="$ECR_REPO:${GITHUB_SHA}"
          TASKDEF_CRON_USE=${TASKDEF_CRON:-wanzami-worker-cron}
          TD=$(aws ecs describe-task-definition --task-definition $TASKDEF_CRON_USE)
          UPDATED=$(echo "$TD" | jq --arg IMG "$IMAGE" '
            .taskDefinition
            | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)
            | .containerDefinitions[0].image = $IMG
          ')
          echo "$UPDATED" > /tmp/td-cron.json
          REV_ARN=$(aws ecs register-task-definition --cli-input-json file:///tmp/td-cron.json --query 'taskDefinition.taskDefinitionArn' --output text)
          aws ecs update-service --cluster $CLUSTER --service $SERVICE_CRON --task-definition "$REV_ARN" --force-new-deployment
